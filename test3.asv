%% Estimation of AR parameters of a non-stationary time series using the 
% Kalman filter
% Then, cluster AR coefficients without low evidence
% Then, EM algorithm (1 iteration)

clearvars
close all
clc

p = 8;
alph = 0.1;
evTh = 0.5;            % Evidence threshold
ncomp = 3;

rng(34)

% Generate synthetic data
Fs = 100;
y = zeros(1, 3*Fs);
t = 1/Fs:1/Fs:3;
for i = 1:3
    t_aux = t(Fs*(i - 1) + 1:Fs*i);
    y(Fs*(i - 1) + 1:Fs*i) = sin(2*pi*10*i*t_aux);
end
% Add noise (0.1 standard deviation)
y = y + 0.1*randn(size(y));

%% Kalman Filter
disp('Kalman Filter')
sig2_n = 0.2;
theta = KalmanAR(y, p, alph, sig2_n);

%% Cluster AR coefficients without low evidence
idxTh = ev_y > evTh;
X = theta(:, idxTh);
GMModel = fitgmdist(X', 3);
idx = cluster(GMModel, theta');

%% E STEP. Forward part
disp('E step')
disp('Forward')
pik = GMModel.ComponentProportion';
pik_ini = pik;
ak = GMModel.mu';
ak_ini = ak;
alph = zeros(ncomp, length(y));
logalpha = zeros(ncomp, length(y));

% Initial transitions
A = [0.98 0.01 0.01;
    0.01 0.98 0.01;
    0.01 0.01 0.98];
A_ini = A;

% First iteration - initialization
i = p+1;
Ft = -fliplr(y(i-p:i-1));
for k = 1:ncomp
    logalpha(k, i) = log(pik(k)) + log(normpdf(y(i), Ft*ak(:,k), sig2_t));
end
for i = p+2:numel(y)
    Ft = -fliplr(y(i-p:i-1));
    for j = 1:ncomp
        a = zeros(1, ncomp);
        lpem = log(normpdf(y(i), Ft*ak(:,j), sig2_t));
        for k = 1:ncomp
            a(k) = lpem + logalpha(k, i-1) + log(A(k, j));
        end
        b = max(a);
        logalpha(j, i) = b + log(sum(exp(a - b)));
    end   
end
%% Backward part
disp('Backward')
logbeta = zeros(ncomp, length(y));

% First iteration - initialization DONE - beta = 1
for i = numel(y)-1:-1:p+1
    Ftp1 = -fliplr(y(i-p+1:i));
    for j = 1:ncomp
        a = zeros(1, ncomp);
        for k = 1:ncomp
            a(k) = logbeta(k, i+1) + log(normpdf(y(i+1), Ftp1*ak(:,k), sig2_t)) + log(A(j, k));
        end
        b = max(a);
        logbeta(j, i) =  b + log(sum(exp(a - b)));
    end
end
%% Conditional posterior of latent variable
disp('gamma')
pX = (sum(exp(logalpha(:,end))));       % Likelihood
gam = zeros(ncomp, length(y));
for i = p+1:numel(y)
    gam(:, i) = (exp(logalpha(:,i)).*exp(logbeta(:,i)))/pX;
end

%% Joint conditional posterior of two latent variables
disp('eta')
eta = zeros(ncomp, ncomp, length(y));
for i = p+2:length(y)
    Ft = -fliplr(y(i-p:i-1));
    for j = 1:ncomp
        for k = 1:ncomp
            eta(j,k, i) = exp(logalpha(j, i - 1))*normpdf(y(i), Ft*ak(:,k), sig2_t)*A(j,k)*exp(logbeta(k, i));
        end
    end
    asd = 1;
end
eta = eta/pX;
disp('E step done')

%% M STEP Initial latent variable probabilities
pik = gam(:,p+1)./sum(gam(:,p+1));

%% State transition probabilities
A = zeros(ncomp, ncomp);
for j = 1:ncomp
    denA = 0;
    for kk = 1:ncomp
        denA = denA + sum(eta(j,kk,p+2:end));
    end
    for k = 1:ncomp
        numA = sum(eta(j,k,p+2:end));
        A(j,k) = numA/denA;
    end
end

%% AR coefficients per mode
X = [];
for i = p + 1:length(y)
    Ft = -fliplr(y(i-p:i-1));
    X = [X; Ft];
end
for k = 1:ncomp
    Ck = diag(sqrt(gam(k, p+1:end)));
    Xtil = Ck*X;
    Ytil = Ck*y(p+1:end)';
    ak(:, k) = (Xtil'*Xtil)\(Xtil'*Ytil);
end

%% Noise variance for each mode
sigk = zeros(1, ncomp);
for k = 1:ncomp
    aux = zeros(1, length(y));
    for i = p+1:length(y)
        Ft = -fliplr(y(i-p:i-1));
        aux(i) = gam(k,i)*(y(i) - Ft*ak(:,k))^2;
    end
    sigk(k) = sum(aux)/sum(gam(k,:));
end
